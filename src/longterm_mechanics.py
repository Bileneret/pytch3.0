import random
from .models import LongTermGoal, Hero


class LongTermManager:
    """
    –ö–ª–∞—Å, —â–æ —Ä–µ–∞–ª—ñ–∑—É—î –º–µ—Ö–∞–Ω—ñ–∫—É –Ω–∞–≥–æ—Ä–æ–¥ —Ç–∞ –ø–æ–∫–∞—Ä–∞–Ω—å
    –¥–ª—è –¥–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤–∏—Ö –∫–≤–µ—Å—Ç—ñ–≤ (–∑–≤–∏—á–æ–∫).
    """

    @staticmethod
    def calculate_interval_reward():
        """
        –Ü–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–∞ –Ω–∞–≥–æ—Ä–æ–¥–∞ = –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ª–µ–≥–∫–æ–≥–æ –∫–≤–µ—Å—Ç—É.
        –ü–æ–≤–µ—Ä—Ç–∞—î (XP, Gold).
        """
        return 50, 50  # 50 XP, 50 Gold

    @staticmethod
    def finalize_quest(quest: LongTermGoal, hero: Hero) -> tuple:
        """
        –ü—ñ–¥–±–∏–≤–∞—î –ø—ñ–¥—Å—É–º–∫–∏ –∫–≤–µ—Å—Ç—É, –ø–æ–≤–µ—Ä—Ç–∞—î —Ç–µ–∫—Å—Ç–æ–≤–∏–π –∑–≤—ñ—Ç,
        XP —Ç–∞ –∑–æ–ª–æ—Ç–æ, –∞ —Ç–∞–∫–æ–∂ –º–æ–∂–µ –Ω–∞–Ω–µ—Å—Ç–∏ —à–∫–æ–¥—É –≥–µ—Ä–æ—é.
        """
        missed = quest.missed_days
        total = quest.total_days
        # –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ –Ω—É–ª—å
        ratio = missed / total if total > 0 else 0

        report = ""
        xp_reward = 0
        gold_reward = 0
        damage = 0
        gear_drop = False

        # 1) –ü—Ä–æ–ø—É—â–µ–Ω–æ 0 (–Ü–¥–µ–∞–ª—å–Ω–æ)
        if missed == 0:
            xp_reward = 1000 * (total / 5)
            gold_reward = 1000 * (total / 5)

            # –®–∞–Ω—Å –Ω–∞ —Å–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è: 2.5% –∑–∞ –¥–µ–Ω—å, –º–∞–∫—Å 75%
            chance = min(total * 2.5, 75.0)
            if random.uniform(0, 100) < chance:
                gear_drop = True

            report = f"–Ü–î–ï–ê–õ–¨–ù–û! –í–∏ –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –∂–æ–¥–Ω–æ–≥–æ –¥–Ω—è!\n–û—Ç—Ä–∏–º–∞–Ω–æ –≤–µ–ª–∏—á–µ–∑–Ω—É –Ω–∞–≥–æ—Ä–æ–¥—É."
            if gear_drop:
                report += "\nüéÅ –í–ò–ü–ê–õ–û –†–Ü–î–ö–Ü–°–ù–ï –°–ü–û–†–Ø–î–ñ–ï–ù–ù–Ø!"

        # 2) –ü—Ä–æ–ø—É—â–µ–Ω–æ –º–µ–Ω—à–µ 1/5 (< 20%)
        elif ratio < 0.2:
            xp_reward = 800 * (total / 5)
            gold_reward = 800 * (total / 5)
            report = "–ß—É–¥–æ–≤–∞ —Ä–æ–±–æ—Ç–∞! –í–∏ –º–∞–π–∂–µ –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–ª–∏ –¥–Ω—ñ–≤.\n–í–µ–ª–∏—á–µ–∑–Ω–∞ –Ω–∞–≥–æ—Ä–æ–¥–∞."

        # 3) –ü—Ä–æ–ø—É—â–µ–Ω–æ –≤—ñ–¥ 1/5 –¥–æ 2/5 (20% - 40%)
        elif 0.2 <= ratio < 0.4:
            xp_reward = 500 * (total / 5)
            gold_reward = 500 * (total / 5)
            report = "–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –í–∏ –¥—ñ–π—à–ª–∏ –¥–æ –∫—ñ–Ω—Ü—è."

        # 4) –ü—Ä–æ–ø—É—â–µ–Ω–æ –≤—ñ–¥ 2/5 –¥–æ 1/2 (40% - 50%)
        elif 0.4 <= ratio < 0.5:
            # –ù–∞–≥–æ—Ä–æ–¥–∞ —è–∫ –∑–∞ 1 –∫–≤–µ—Å—Ç —Å–µ—Ä–µ–¥–Ω—å–æ—ó —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ
            xp_reward = 100
            gold_reward = 100
            report = "–í–∏ –≤–ø–æ—Ä–∞–ª–∏—Å—è, –∞–ª–µ –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω—É –º–æ–∂–Ω–∞ –ø—ñ–¥—Ç—è–≥–Ω—É—Ç–∏."

        # 5) –ü—Ä–æ–ø—É—â–µ–Ω–æ –±—ñ–ª—å—à–µ –ø–æ–ª–æ–≤–∏–Ω–∏ (> 50%)
        elif ratio >= 0.5 and ratio < 1.0:
            damage = 20  # –ë–∞–∑–æ–≤–∞ —à–∫–æ–¥–∞
            hero.hp = max(0, hero.hp - damage)
            report = LongTermManager.get_ai_motivation(severity="medium")
            report += f"\n\nüí• –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –∑–∞–≤–¥–∞–≤ —É–¥–∞—Ä—É: -{damage} HP!"

        # 6) –ü—Ä–æ–ø—É—â–µ–Ω–æ –≤—Å–µ (100%)
        elif missed == total:
            report = LongTermManager.get_ai_motivation(severity="critical")
            report = "üÜò –°–ò–°–¢–ï–ú–ù–ï –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø:\n" + report

        return report, int(xp_reward), int(gold_reward)

    @staticmethod
    def get_ai_motivation(severity: str) -> str:
        """
        –Ü–º—ñ—Ç–∞—Ü—ñ—è –Ü–Ü-–º–æ—Ç–∏–≤–∞—Ç–æ—Ä–∞.
        """
        if severity == "medium":
            return ("ü§ñ AI: –ü—Ä–∏–≤—ñ—Ç. –Ø –±–∞—á—É, —Ç–∏ –ø—Ä–æ–ø—É—Å—Ç–∏–≤ –±–∞–≥–∞—Ç–æ –∑–∞–Ω—è—Ç—å. "
                    "–ü–∞–º'—è—Ç–∞–π, —â–æ –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞ ‚Äî —Ü–µ –º'—è–∑. –ü–æ—á–Ω–∏ –∑ –º–∞–ª–æ–≥–æ –∑–∞–≤—Ç—Ä–∞.")
        elif severity == "critical":
            return ("ü§ñ AI: –°–ª—É—Ö–∞–π, —è –ø–æ–º—ñ—Ç–∏–≤, —â–æ —Ç–∏ –∑–æ–≤—Å—ñ–º –∑–∞–∫–∏–Ω—É–≤ —Ü—é —Ü—ñ–ª—å. "
                    "–ù–µ –∫–∞—Ä—Ç–∞–π —Å–µ–±–µ. –Ü–Ω–æ–¥—ñ –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω –≤—ñ–¥–ø–æ—á–∏–Ω–æ–∫. –ê–ª–µ –Ω–µ –∑–¥–∞–≤–∞–π—Å—è.")
        return ""